{% extends "base.html" %}
{% load static %}

{% block title %}Recipe Detail - {{recipe.title}}{% endblock %}

{% block content %}

<style>
  /* Chatbot Section */
  .chatbot-section {
      text-align: center;
      margin-top: 20px;
      padding: 10px;
      position: relative;
  }

  .chatbot-text {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
  }

  .chat-icon {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 50px;
      cursor: pointer;
      font-size: 16px;
      margin-bottom: 10px;
  }

  .chatbot-logo {
      display: block;
      margin: 0 auto;
      width: 120px; /* Adjust as needed */
      height: auto;
  }

  /* Chatbox Styling */
  .chatbox-container {
      display: none; /* Initially hidden */
      position: relative;
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
      overflow: hidden;
      z-index: 1000;
  }

  .chatbox-header {
      background: #007bff;
      color: white;
      padding: 10px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
  }

  .close-chat {
      background: none;
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
  }

  .chatbox-body {
      height: 250px;
      overflow-y: auto;
  }

  .chatbox-footer {
      padding: 10px;
      border-top: 1px solid #ddd;
      display: flex;
  }

  .chatbox-footer input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
  }

  .chatbox-footer button {
      background: #007bff;
      color: white;
      border: none;
      padding: 8px 12px;
      margin-left: 5px;
      border-radius: 5px;
      cursor: pointer;
  }
</style>


<div class="container">

  <div class="recipe-info mt-4 p-1 row">

    <div class="recipe-img col-md-6">
      <img src="{{ recipe.image.url }}" alt="{{ recipe.image_alt }}" class="recipe-pic rounded">

    </div>

    <div class="recipe-detail  col-md-6">

      <h1 class="text-center">{{ recipe.title }}</h1>
      <p class="text-center">Posted by {{recipe.user}} on {{recipe.posted_date}} </p>
      <div class="card  " style="background-color:#ffedbd;">
        <div class="card-body">
          <p class="card-text ">

          <p class="p-3 text-center"><i class="bi bi-stopwatch-fill"></i><strong>Preparation Time: </strong> Hours:{{
            recipe.preptime_hours }} Minutes: {{ recipe.preptime_minutes }}</p>
          <p class="p-3 text-center"><i class="bi bi-egg-fried"></i><strong>Servings: </strong> {{ recipe.servings }}
          </p>
          <p class="p-3 text-center"><i class="bi bi-hourglass-split"></i><strong>Cook Time: </strong> Hours: {{
            recipe.cooktime_hours }} Minutes: {{ recipe.cooktime_minutes }} </p>
          <p class="p-3 text-center"><i class="bi bi-piggy-bank-fill"></i><strong>Estimated Cost: </strong> {{
            recipe.price }}</p>

          </p>
        </div>
      </div>

      <hr>
      <p>{{recipe.description}}</p>
      <p class="p-3"><strong>Calories: </strong> {{ recipe.calories }}</p>
      <p class="p-3"><strong>Cuisine: </strong> {{ recipe.cuisine_types|title }}</p>
      <p class="p-3"><strong>Recipe Difficulty: </strong> {{ recipe.recipe_difficulty|title }}</p>
      <p class="p-3"><strong>Rating:</strong> {{ recipe.rating|default:"No rating yet" }} stars</p>

      <hr>

      {% if request.user == recipe.user %}
      <div class="text-center">
        <a href="{% url 'edit_recipe' recipe.id %}" class="btn btn-primary w-25">Edit</a>
        <a href="{% url 'delete_recipe' recipe.id %}" class="btn btn-primary w-25">Delete</a>
      </div>
      {% endif %}
    </div>
  </div>



  <div class="container">

    <div class="recipe-container row mt-4 ">
      <div class="col ingredients card border-dark mb-3">
        <div class="card-header">Ingredients</div>
        <div class="card-body text-dark">
          <p class="card-text">{{ recipe.ingredients|safe }}</p>

  <!-- Chatbot Section Below Recipe Ingredients -->
<div class="chatbot-section mb-5" id="chatbot-section">
  <p class="chatbot-text">Need help in conversion?</p>
  <button class="chat-icon" onclick="toggleChatbox()">
      <i class="fas fa-comments"></i>
  </button>
  <img src="{% static 'images/goodfood.png' %}" alt="Good Food Logo" class="chatbot-logo">
</div>

<!-- Chatbox Container (Hidden by Default) -->
<div class="chatbox-container mt-5" id="chatbox-container">
  <div class="chatbox-header">
      <span>Chatbot</span>
      <button onclick="toggleChatbox()" class="close-chat">âœ–</button>
  </div>
  <div class="chatbox-body">
      <div class="chatbot-result"></div>
  </div>
  <div class="chatbox-footer">
      <form onsubmit="handleChatbotFormSubmit(event)">
          <input type="text" name="query" placeholder="Type a message..." required>
          <button type="submit">Send</button>
      </form>
  </div>
</div>



        </div>
      </div>

      <div class="col instructions card border-dark mb-3">
        <div class="card-header">Instructions</div>
        <div class="card-body text-dark">
          <p class="card-text">{{ recipe.instructions|safe }}</p>
        </div>
      </div>

    </div>

    <h2 class="text-center">Rate this recipe<br><span id="boot-icon" class="bi bi-star-fill"
        style="font-size: 18px; color: rgb(255, 210, 48);">&nbsp&nbsp&nbsp<span id="boot-icon" class="bi bi-star-fill"
          style="font-size: 18px; color: rgb(255, 210, 48);">&nbsp&nbsp&nbsp<span id="boot-icon" class="bi bi-star-fill"
            style="font-size: 18px; color: rgb(255, 210, 48);"></span>&nbsp&nbsp&nbsp<span id="boot-icon"
            class="bi bi-star-fill" style="font-size: 18px; color: rgb(255, 210, 48);"></span>&nbsp&nbsp&nbsp<span
            id="boot-icon" class="bi bi-star-fill"
            style="font-size: 18px; color: rgb(255, 210, 48);">&nbsp&nbsp&nbsp</span></span>
      </span></h2>

    <div class="text-center">
      <form method="post" action="{% url 'rate_recipe' recipe.id %}">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="btn btn-primary">Rate</button>
      </form>

      {% if request.user == recipe.user %}
      <div class="alert alert-warning mt-2 mb-2" role="alert">
        {% if rating %}
        <p>You rated this recipe <strong>{{ rating }}</strong> stars!</p>
        {% endif %}
        {% endif %}

      </div>

    </div>
  </div>
</div>


<script>
  function toggleChatbox() {
    var chatboxContainer = document.getElementById('chatbox-container');
    chatboxContainer.style.display = chatboxContainer.style.display === 'none' || chatboxContainer.style.display === '' ? 'block' : 'none';
}



  // Handle chatbot form submission
  function handleChatbotFormSubmit(event) {
    event.preventDefault();

    var form = event.target;
    var formData = new FormData(form);

    // Send an AJAX request to submit the chatbot form
    fetch(form.action, {
      method: form.method,
      body: formData
    })
      .then(response => response.text())
      .then(data => {
        // Extract the recent query and chatbot response from the data using regular expressions
        var queryMatch = data.match(/User: (.*?)<\/p>/g);
        var query = queryMatch ? queryMatch[queryMatch.length - 1].replace('User: ', '') : '';

        var responseMatch = data.match(/Chatbot: (.*?)<\/p>/g);
        var response = responseMatch ? responseMatch[responseMatch.length - 1].replace('Chatbot: ', '') : '';

        // Create the HTML for the recent query and chatbot response
        var conversationHtml = '<p>User: ' + query + '</p>';
        conversationHtml += '<p>Chatbot: ' + response + '</p>';

        // Display the recent query and chatbot response in the chatbox interface
        var chatboxContainer = document.querySelector('.chatbox-container');
        var chatboxResult = chatboxContainer.querySelector('.chatbot-result');
        var currentContent = chatboxResult.innerHTML;
        var newContent = currentContent + conversationHtml;
        chatboxResult.innerHTML = newContent;

        // Clear the text input field
        var userInput = chatboxContainer.querySelector('input[name="query"]');
        userInput.value = '';

        // Scroll to the bottom of the chatbox
        chatboxResult.scrollTop = chatboxResult.scrollHeight;


      })
      .catch(error => {
        console.error('Error submitting chatbot form:', error);
      });
  }




</script>






{% endblock %}